<header
  class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-slate-100 shadow-sm">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="flex h-16 items-center justify-between">

      <!-- Brand -->
      <a
        routerLink="/home"
        (click)="close()"
        class="flex items-center gap-3"
      >
        <span
          class="inline-grid place-items-center w-9 h-9 rounded-2xl bg-gradient-to-br from-indigo-500 to-fuchsia-500 text-white font-bold shadow-md">
          CP
        </span>
        <div class="leading-tight">
          <span class="block font-extrabold text-slate-900 tracking-tight">
            CloPets
          </span>
          <span class="block text-xs text-slate-400 -mt-0.5">
            Tienda para mascotas
          </span>
        </div>
      </a>

      <!-- Desktop nav -->
      <nav class="hidden md:flex items-center gap-6">

        <a
          routerLink="/home"
          routerLinkActive="text-indigo-600"
          [routerLinkActiveOptions]="{ exact: true }"
          class="relative text-sm font-medium text-slate-700 hover:text-indigo-600 transition-colors
                 after:content-[''] after:absolute after:left-0 after:-bottom-1 after:h-[2px]
                 after:w-0 after:bg-indigo-500 after:rounded-full after:transition-all hover:after:w-full">
          Inicio
        </a>

        <a
          routerLink="/productos"
          routerLinkActive="text-indigo-600"
          class="relative text-sm font-medium text-slate-700 hover:text-indigo-600 transition-colors
                 after:content-[''] after:absolute after:left-0 after:-bottom-1 after:h-[2px]
                 after:w-0 after:bg-indigo-500 after:rounded-full after:transition-all hover:after:w-full">
          Productos
        </a>

        <ng-container *ngIf="currentUser$ | async">
          <a
            routerLink="/pedidos/historial"
            routerLinkActive="text-indigo-600"
            class="relative text-sm font-medium text-slate-700 hover:text-indigo-600 transition-colors
                   after:content-[''] after:absolute after:left-0 after:-bottom-1 after:h-[2px]
                   after:w-0 after:bg-indigo-500 after:rounded-full after:transition-all hover:after:w-full">
            Pedidos
          </a>
        </ng-container>

        <!-- Carrito (desktop) -->
        <button
          type="button"
          (click)="toggleCart()"
          class="relative inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-3 py-2
                 hover:bg-slate-50 hover:border-indigo-200 transition shadow-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-800" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
                  d="M3 3h2l.4 2M7 13h10l3-8H6.4M7 13L5.4 5M7 13l-2 7h14m-8 0a1.5 1.5 0 11-3 0m10 0a1.5 1.5 0 11-3 0" />
          </svg>

          <!-- badge cantidad -->
          <ng-container *ngIf="(carrito$ | async)?.totalItems as count">
            <span
              *ngIf="count > 0"
              class="absolute -top-1 -right-1 min-w-[18px] h-[18px] rounded-full bg-rose-500 text-white
                     text-[10px] leading-[18px] text-center font-semibold shadow">
              {{ count }}
            </span>
          </ng-container>
        </button>

        <!-- Auth area desktop -->
        <ng-container *ngIf="!(currentUser$ | async); else loggedDesktop">
          <a
            routerLink="/auth/login"
            class="inline-flex items-center rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold
                   text-slate-800 hover:border-indigo-300 hover:text-indigo-600 hover:bg-indigo-50 transition shadow-sm">
            Ingresar
          </a>
        </ng-container>

        <!-- Si hay usuario logueado -->
        <ng-template #loggedDesktop>
          <div class="relative">
            <button
              type="button"
              (click)="toggleUserMenu()"
              class="inline-flex items-center gap-2 rounded-full bg-slate-50 px-3 py-1.5 border border-slate-200
                     hover:bg-indigo-50 hover:border-indigo-200 transition shadow-sm">
              <div
                class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-fuchsia-500 text-white flex items-center justify-center text-xs font-semibold shadow">
                {{ (currentUser$ | async)?.nombre?.[0] | uppercase }}
              </div>
              <span class="text-sm text-slate-800">
                {{ (currentUser$ | async)?.nombre }}
              </span>
            </button>

            <!-- Menú usuario -->
            <div
              *ngIf="userMenuOpen()"
              class="absolute right-0 mt-2 w-48 rounded-2xl bg-white border border-slate-100 shadow-lg overflow-hidden z-50">
              <a
                routerLink="/auth/perfil"
                (click)="closeUserMenu()"
                class="block px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-50">
                Mi cuenta
              </a>
              <button
                (click)="logout()"
                class="w-full text-left block px-4 py-2.5 text-sm text-rose-500 hover:bg-rose-50">
                Cerrar sesión
              </button>
            </div>
          </div>
        </ng-template>
      </nav>

      <!-- Botón menú mobile -->
      <button
        type="button"
        (click)="toggle()"
        aria-label="Abrir menú"
        class="md:hidden inline-flex items-center justify-center rounded-full border border-slate-200 bg-white p-2
               hover:bg-slate-50 hover:border-indigo-200 transition shadow-sm">
        <svg *ngIf="!open()" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-800" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M3.75 6.75h16.5M3.75 12h16.5M3.75 17.25h16.5" />
        </svg>
        <svg *ngIf="open()" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-800" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Mobile nav -->
    <div *ngIf="open()" class="md:hidden pb-4 animate-[fadeIn_.15s_ease-in]">
      <nav class="mt-2 grid gap-2 rounded-2xl border border-slate-100 bg-white/95 p-2 shadow-sm">
        <a
          routerLink="/home"
          (click)="close()"
          class="rounded-xl px-3 py-2 text-sm font-medium text-slate-800 hover:bg-slate-50">
          Inicio
        </a>
        <a
          routerLink="/productos"
          (click)="close()"
          class="rounded-xl px-3 py-2 text-sm font-medium text-slate-800 hover:bg-slate-50">
          Productos
        </a>

        <ng-container *ngIf="currentUser$ | async">
          <a
            routerLink="/pedidos/historial"
            (click)="close()"
            class="rounded-xl px-3 py-2 text-sm font-medium text-slate-800 hover:bg-slate-50">
            Pedidos
          </a>
        </ng-container>

        <button
          type="button"
          (click)="toggleCart(); close()"
          class="text-left rounded-xl px-3 py-2 text-sm font-medium text-slate-800 hover:bg-slate-50">
          Carrito
        </button>

        <ng-container *ngIf="!(currentUser$ | async); else loggedMobile">
          <a
            routerLink="/auth/login"
            (click)="close()"
            class="rounded-full px-3 py-2 text-sm font-semibold text-slate-800 border border-slate-200
                   hover:border-indigo-300 hover:bg-indigo-50 hover:text-indigo-600 transition">
            Ingresar
          </a>
        </ng-container>

        <ng-template #loggedMobile>
          <a
            routerLink="/auth/perfil"
            (click)="close()"
            class="rounded-xl px-3 py-2 text-sm font-medium text-slate-800 hover:bg-slate-50">
            Mi cuenta
          </a>
          <button
            (click)="logout()"
            class="rounded-xl px-3 py-2 text-sm font-semibold text-rose-500 hover:bg-rose-50 text-left">
            Cerrar sesión
          </button>
        </ng-template>
      </nav>
    </div>
  </div>
</header>

<!-- Drawer / Slide del carrito -->
<ng-container *ngIf="cartOpen()">
  <div class="fixed inset-0 z-[60]">
    <!-- Overlay oscuro -->
    <div
      class="absolute inset-0 bg-black/40"
      (click)="closeCart()">
    </div>

    <!-- Panel lateral -->
    <aside
      class="absolute inset-y-0 right-0 w-full max-w-md bg-white shadow-2xl rounded-l-3xl p-6 flex flex-col"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-slate-900">Tu carrito</h2>
        <button
          type="button"
          (click)="closeCart()"
          class="rounded-full p-2 hover:bg-slate-100 text-slate-500"
        >
          ✕
        </button>
      </div>

      <ng-container *ngIf="(carrito$ | async) as carrito">
        <!-- Lista de items -->
        <div
          *ngIf="carrito.items?.length; else carritoVacio"
          class="flex-1 overflow-y-auto divide-y divide-slate-100"
        >
          <div
            *ngFor="let item of carrito.items"
            class="flex gap-3 py-4"
          >
            <img
              [src]="'http://localhost:3000/public/images/' + item.producto.imagen_principal"
              [alt]="item.producto.nombre"
              class="w-16 h-16 rounded-xl object-cover border border-slate-100"
            />

            <div class="flex-1">
              <p class="text-sm font-medium text-slate-900">
                {{ item.producto.nombre }}
              </p>
              <p class="text-xs text-slate-500 mt-0.5">
                {{ item.precio | currency:'ARS':'symbol':'1.2-2':'es-AR' }}
              </p>

              <div class="mt-2 flex items-center gap-2">
                <span class="text-xs text-slate-500">Cant.</span>
                <span
                  class="inline-flex items-center justify-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium">
                  {{ item.cantidad }}
                </span>

                <span class="ml-2 text-xs text-slate-500">
                  Subtotal:
                  {{ item.subtotal | currency:'ARS':'symbol':'1.2-2':'es-AR' }}
                </span>

                <button
                  type="button"
                  (click)="removeCartItem(item)"
                  class="ml-auto text-xs text-rose-500 hover:text-rose-600"
                >
                  Quitar
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Carrito vacío -->
        <ng-template #carritoVacio>
          <div class="flex-1 flex flex-col items-center justify-center text-center text-slate-500">
            <p class="text-sm">Tu carrito está vacío.</p>
          </div>
        </ng-template>

        <!-- Total + botón checkout -->
        <div class="pt-4 mt-4 border-t border-slate-100" *ngIf="carrito.items?.length">
          <div class="flex items-center justify-between">
            <span class="text-sm font-semibold text-slate-700">Total</span>
            <span class="text-base font-semibold text-violet-600">
              {{ carrito.totalAmount | currency:'ARS':'symbol':'1.2-2':'es-AR' }}
            </span>
          </div>

          <button
            type="button"
            class="mt-4 w-full inline-flex items-center justify-center rounded-xl bg-violet-600 text-white text-sm font-semibold py-2.5 hover:bg-violet-700 transition"
            (click)="goToCheckout()"
          >
            Ir al checkout
          </button>
        </div>
      </ng-container>
    </aside>
  </div>
</ng-container>
