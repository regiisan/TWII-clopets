<p-toast></p-toast>

<div class="w-full bg-white py-8 px-6 sm:px-8 border border-slate-200 rounded-3xl shadow-sm">

  <!-- Encabezado + acciones -->
  <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
    <h2 class="text-xl font-semibold text-slate-900 tracking-tight">
      Productos
    </h2>

    <!-- Bloque de controles -->
    <div
      class="flex flex-wrap items-center gap-3 bg-slate-50 border border-slate-200 rounded-2xl px-3 py-2.5 shadow-xs">

      <!-- Botón FILTRAR -->
      <button
        (click)="toggleFilters()"
        class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-slate-300
               bg-white text-xs sm:text-sm font-semibold text-slate-900
               hover:bg-slate-100 hover:border-violet-400 hover:text-violet-700
               transition-colors"
      >
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-violet-100 text-violet-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
            <path
              d="M3 4.75A.75.75 0 013.75 4h12.5a.75.75 0 01.53 1.28L12 10.03v4.22a.75.75 0 01-.41.67l-2.5 1.25A.75.75 0 018 15.5v-5.47L3.22 5.28A.75.75 0 013 4.75z" />
          </svg>
        </span>
        <span>Filtrar</span>
      </button>

      <!-- Buscador -->
      <div class="relative">
        <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M9 3.5a5.5 5.5 0 103.473 9.736l3.645 3.646a.75.75 0 001.06-1.06l-3.646-3.645A5.5 5.5 0 009 3.5zm-4 5.5a4 4 0 118 0 4 4 0 01-8 0z"
              clip-rule="evenodd" />
          </svg>
        </span>
        <input
          type="search"
          placeholder="Buscar productos..."
          class="h-10 pl-9 pr-3 rounded-full border border-slate-200 bg-white/80 text-sm
                 text-slate-900 placeholder:text-slate-400
                 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-violet-500
                 w-[220px] sm:w-[260px]"
          [formControl]="form.controls.q"
        />
      </div>

      <!-- Orden -->
      <select
        class="h-10 px-3 pr-8 rounded-full border border-slate-200 bg-white text-sm text-slate-900
               focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-violet-500"
        [formControl]="form.controls.sort"
      >
        <option value="newest">Más nuevos</option>
        <option value="price_asc">Precio ↓</option>
        <option value="price_desc">Precio ↑</option>
      </select>

      <!-- Total resultados -->
      <span
        class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-medium text-slate-600"
        *ngIf="!loading"
      >
        {{ total }} resultado{{ total === 1 ? '' : 's' }}
      </span>
    </div>
  </div>

  <!-- Drawer de filtros (no tapa el header) -->
  <div class="fixed inset-x-0 bottom-0 top-16 z-40" *ngIf="openFilters">
    <!-- overlay suave -->
    <div class="absolute inset-0 bg-black/10" (click)="toggleFilters()"></div>

    <aside
      class="absolute right-0 top-0 h-full w-full max-w-sm bg-white shadow-xl p-5 overflow-y-auto
             text-neutral-900 border-l border-neutral-200 rounded-l-3xl"
    >
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-neutral-900">Filtros</h3>
        <button (click)="toggleFilters()" class="text-sm text-neutral-600 hover:text-neutral-900">
          Cerrar
        </button>
      </div>

      <!-- PRECIO -->
      <div class="mb-6">
        <h4 class="text-xs font-semibold text-neutral-700 mb-2">PRECIO</h4>
        <div class="flex gap-3">
          <input
            type="number"
            class="w-1/2 px-3 py-2 rounded-xl border border-neutral-300 bg-white text-neutral-900 placeholder:text-neutral-400"
            placeholder="$ mín."
            [formControl]="form.controls.precioMin"
          />
          <input
            type="number"
            class="w-1/2 px-3 py-2 rounded-xl border border-neutral-300 bg-white text-neutral-900 placeholder:text-neutral-400"
            placeholder="$ máx."
            [formControl]="form.controls.precioMax"
          />
        </div>
        <p class="text-xs text-neutral-500 mt-2">
          Rango: {{ priceMinMax.min | currency:'ARS' }} – {{ priceMinMax.max | currency:'ARS' }}
        </p>
      </div>

      <!-- ANIMAL -->
      <div class="mb-6">
        <h4 class="text-xs font-semibold text-neutral-700 mb-2">ANIMAL</h4>

        <ng-container *ngIf="animals?.length; else noAnimalsTpl">
          <div class="flex flex-col gap-2 max-h-44 overflow-auto pr-1">
            <label class="flex items-center gap-2" *ngFor="let a of animals">
              <input
                type="checkbox"
                class="accent-violet-600"
                [checked]="form.value.animal?.includes(a)"
                (change)="toggleCheck('animal', a, $event.target.checked)"
              />
              <span class="text-sm text-neutral-800">{{ a }}</span>
            </label>
          </div>
        </ng-container>

        <ng-template #noAnimalsTpl>
          <p class="text-xs text-neutral-400">
            No hay filtros por animal disponibles.
          </p>
        </ng-template>
      </div>

      <!-- CLASIFICACIÓN -->
      <div class="mb-6">
        <h4 class="text-xs font-semibold text-neutral-700 mb-2">CLASIFICACIÓN</h4>

        <ng-container *ngIf="clasifs?.length; else noClasifsTpl">
          <div class="flex flex-col gap-2 max-h-44 overflow-auto pr-1">
            <label class="flex items-center gap-2" *ngFor="let c of clasifs">
              <input
                type="checkbox"
                class="accent-violet-600"
                [checked]="form.value.clasificacion?.includes(c)"
                (change)="toggleCheck('clasificacion', c, $event.target.checked)"
              />
              <span class="text-sm text-neutral-800">{{ c }}</span>
            </label>
          </div>
        </ng-container>

        <ng-template #noClasifsTpl>
          <p class="text-xs text-neutral-400">
            No hay filtros por clasificación disponibles.
          </p>
        </ng-template>
      </div>

      <!-- Botones -->
      <div class="flex gap-3 mt-4">
        <button
          class="flex-1 px-4 py-2 rounded-xl bg-violet-600 text-white font-semibold hover:bg-violet-700 transition"
          (click)="toggleFilters()"
        >
          APPLY
        </button>
        <button
          class="px-4 py-2 rounded-xl border border-neutral-300 text-neutral-800 hover:bg-neutral-50 transition"
          (click)="resetFilters()"
        >
          RESET
        </button>
      </div>
    </aside>
  </div>

  <!-- Grid: loading skeleton -->
  <div *ngIf="loading" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
    <div *ngFor="let _ of [1,2,3,4,5,6,7,8]" class="animate-pulse">
      <div class="w-full h-60 bg-neutral-200 rounded-2xl mb-3"></div>
      <div class="h-4 bg-neutral-200 rounded w-3/4 mb-2"></div>
      <div class="h-4 bg-neutral-200 rounded w-1/2"></div>
    </div>
  </div>

  <!-- Grid: productos -->
  <div *ngIf="!loading && productos?.length" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
    <app-card-productos-list
      *ngFor="let producto of productos"
      [producto]="producto"
    >
    </app-card-productos-list>
  </div>

  <!-- Vacío -->
  <div *ngIf="!loading && (!productos || !productos.length)" class="py-16 text-center">
    <p class="text-neutral-600 mb-4">No encontramos productos para mostrar.</p>
    <button
      class="inline-flex items-center px-4 py-2 rounded-xl border border-neutral-300 hover:bg-neutral-50 text-sm font-semibold text-neutral-900"
      (click)="listarProductos()"
    >
      Reintentar
    </button>
  </div>
</div>
